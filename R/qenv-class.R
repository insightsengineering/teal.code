#' Reproducible class with environment and code
#'
#' Reproducible class with environment and code.
#' @name qenv-class
#' @rdname qenv-class
#' @slot code (`character`) representing code necessary to reproduce the environment
#' @slot .xData (`environment`) environment with content was generated by the evaluation
#'  of the `code` slot.
#' @slot id (`integer`) random identifier of the code element to make sure uniqueness
#'  when joining.
#' @slot warnings (`character`) the warnings output when evaluating the code
#' @slot messages (`character`) the messages output when evaluating the code
#' @keywords internal
#' @exportClass qenv
setClass(
  "qenv",
  slots = c(
    code = "character",
    id = "integer",
    warnings = "character",
    messages = "character"
  ),
  contains = "environment"
)

#' It initializes the `qenv` class
#' @noRd
setMethod(
  "initialize",
  "qenv",
  function(.Object, # nolint: object_name.
           .xData, # nolint: object_name.
           code = character(0L),
           warnings = rep("", length(code)),
           messages = rep("", length(code)),
           id = integer(0L),
           ...) {
    # # Pre-process parameters to ensure they are ready to be used by parent constructors
    stopifnot("`code` must be a character or language object." = any(is.language(code), is.character(code)))

    if (is.language(code)) {
      code <- paste(lang2calls(code), collapse = "\n")
    }
    if (length(code)) {
      code <- paste(code, collapse = "\n")
    }

    if (length(id) == 0L) {
      id <- sample.int(.Machine$integer.max, size = length(code))
    }

    new_xdata <- if (rlang::is_missing(.xData)) {
      new.env(parent = parent.env(.GlobalEnv))
    } else {
      checkmate::assert_environment(.xData)
      rlang::env_clone(.xData, parent = parent.env(.GlobalEnv))
    }
    lockEnvironment(new_xdata, bindings = TRUE)

    # .xData needs to be unnamed as the `.environment` constructor allows at
    # most 1 unnamed formal argument of class `environment`.
    # See methods::findMethods("initialize")$.environment
    .Object <- methods::callNextMethod( # nolint: object_name.
      # Mandatory use of `xData` to build a correct .Object@.xData
      .Object, new_xdata,
      code = code, messages = messages, warnings = warnings, id = id, ...
    )

    .Object
  }
)

#' It takes a `qenv` class and returns `TRUE` if the input is valid
#' @name qenv-class
#' @keywords internal
setValidity("qenv", function(object) {
  if (length(object@code) != length(object@id)) {
    "@code and @id slots must have the same length."
  } else if (length(object@code) != length(object@warnings)) {
    "@code and @warnings slots must have the same length"
  } else if (length(object@code) != length(object@messages)) {
    "@code and @messages slots must have the same length"
  } else if (any(duplicated(object@id))) {
    "@id contains duplicated values."
  } else if (!environmentIsLocked(object@.xData)) {
    "@.xData must be locked."
  } else {
    TRUE
  }
})
